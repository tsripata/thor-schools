<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ตารางเปรียบเทียบโรงเรียน (โซนพุทธมณฑลสาย 2)</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y41Z7TFF2D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y41Z7TFF2D');
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{ --bg:#0b1220; --panel:#111a2b; --muted:#9fb0c7; --text:#e8eef6; --brand:#5bd1ff; --accent:#85f089; --chip:#1a2740; --chip2:#0f1b30; --warn:#ffd166; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0a1326 40%, #091021);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
  a{color:var(--brand);text-decoration:none}
  .wrap{max-width:1200px;margin:auto;padding:24px}
  header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  header h1{font-size:clamp(20px,3vw,28px);margin:0}
  .panel{background:rgba(255,255,255,0.03);backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,0.07);border-radius:14px}
  .filters{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:16px}
  .filters > *{grid-column:span 12}
  @media(min-width:720px){.filters > .col-4{grid-column:span 4}}
  @media(min-width:720px){.filters > .col-3{grid-column:span 3}}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--text)}
  input::placeholder{color:#9bb}
  button{cursor:pointer}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid rgba(255,255,255,0.08);font-size:12px;color:#cfe3ff}
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;margin-top:14px;font-size:14px}
  .card{position:relative;padding:10px;display:flex;flex-direction:column;gap:8px}
  .title{font-weight:700;display:flex;align-items:center;gap:12px}
  .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:var(--chip2);border:1px solid rgba(255,255,255,0.06)}
  .proscons{display:grid;grid-template-columns:1fr;gap:20px}
  .proscons ul{margin:0 0 0 18px}
  .proscons li{margin-bottom:6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);font-size:12px}
  .soft{color:var(--muted)}
  .warn{color:#2b2b2b;background:var(--warn)}
  footer{opacity:.7;margin:20px 0 80px;font-size:13px}
  .ghost{border:1px dashed rgba(255,255,255,0.12)}
  /* โลโก้ */
  .logo{width:40px;height:40px;border-radius:10px;background:#0f1b30;border:1px solid rgba(255,255,255,0.1);display:grid;place-items:center;overflow:hidden}
  .logo img{display:block;width:100%;height:100%;object-fit:contain;background:#fff}
  .logo .initial{font-weight:800;color:#17223a}
  .logoBar{margin-left:auto;display:flex;gap:8px}
  .tests{margin-left:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left}
  th:nth-child(2),th:nth-child(3),td:nth-child(2),td:nth-child(3){text-align:right}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="flex:1 1 auto">
        <h1>เปรียบเทียบโรงเรียน (จุดอ้างอิง: โซนพุทธมณฑลสาย 2)</h1>
        <div class="soft">ภาษา: ไทย • อัปเดต: ส.ค. 2568 • ไม่มีข้อมูลส่วนบุคคลระบุที่อยู่</div>
      </div>
      <div class="row">
        <button id="btnReset" title="ล้างตัวกรอง" class="pill ghost">ล้างตัวกรอง</button>
        <button id="btnExport" class="pill">ดาวน์โหลด CSV</button>
        <button id="btnTest" class="pill tests" title="รันการทดสอบภายใน">ตรวจสอบระบบ</button>
      </div>
    </header>

    <section class="panel filters" aria-label="ตัวกรองและการค้นหา">
      <input id="q" placeholder="ค้นหา: ชื่อโรงเรียน / หมวด / หลักสูตร / หมายเหตุค่าเทอม" class="col-4" />
      <select id="system" class="col-3" title="ระบบการสอน">
        <option value="">ระบบการสอน — ทั้งหมด</option>
        <option>อังกฤษ</option>
        <option>สิงคโปร์</option>
        <option>อเมริกัน</option>
        <option>สองภาษา</option>
        <option>ทางเลือก</option>
      </select>
      <select id="sort" class="col-3" title="เรียงลำดับ">
        <option value="name">เรียงตามชื่อ</option>
        <option value="distance">ระยะทาง (กม.)</option>
        <option value="normal">เวลาไป (ปกติ)</option>
        <option value="peak8">เวลาไป 08:00</option>
        <option value="peak15">เวลากลับ 15:00</option>
      </select>
      <div class="row col-4">
        <label class="soft" style="min-width:160px">ระยะทางสูงสุด (กม.)</label>
        <input id="maxKm" type="range" min="0" max="40" value="40" style="flex:1"/>
        <div id="maxKmVal" class="pill">≤ 40 กม.</div>
      </div>
      <div class="row col-4">
        <label class="soft" style="min-width:160px">กรองเวลาไป รร. (08:00)</label>
        <input id="maxGo" type="range" min="0" max="120" value="120" style="flex:1"/>
        <div id="maxGoVal" class="pill">≤ 120 นาที</div>
      </div>
      <div class="row col-4">
        <label class="soft" style="min-width:160px">กรองเวลากลับบ้าน (15:00)</label>
        <input id="maxBack" type="range" min="0" max="120" value="120" style="flex:1"/>
        <div id="maxBackVal" class="pill">≤ 120 นาที</div>
      </div>
  <div class="chips col-12" id="quick">
    <span class="chip" data-sys="ทางเลือก">#ทางเลือก</span>
    <span class="chip" data-sys="อังกฤษ">#อังกฤษ</span>
    <span class="chip" data-sys="สิงคโปร์">#สิงคโปร์</span>
    <span class="chip" data-sys="อเมริกัน">#อเมริกัน</span>
    <span class="chip" data-sys="สองภาษา">#สองภาษา</span>
  </div>
</section>

    <section id="charts" class="panel" style="margin-top:14px;padding:16px">
      <canvas id="chartAll" height="220"></canvas>
    </section>

      <section id="results" class="list" aria-live="polite"></section>

      <footer>
        <p>หมายเหตุ: เวลาเดินทางเป็นค่าประมาณ—“เวลา 15:00” คือเวลากลับจากโรงเรียนมาบ้าน • สามารถอัปโหลดโลโก้ทับได้และจะถูกเก็บไว้เฉพาะในเบราว์เซอร์ของคุณ</p>
      </footer>

      <section id="summary" class="panel" style="margin-top:14px;padding:16px;overflow-x:auto;display:none">
        <table>
          <thead>
            <tr>
              <th>โรงเรียน</th>
              <th>ไป 08:00 (นาที)</th>
              <th>กลับ 15:00 (นาที)</th>
              <th>ค่าเทอม</th>
              <th>ข้อดี</th>
              <th>ข้อเสีย</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>
      </section>
  </div>

<script src="schools.js"></script>
<script>
// ป้องกันข้อผิดพลาดจากสคริปต์ภายนอก (ไม่มีการเชื่อมต่อกระเป๋าเงินใด ๆ ในหน้านี้)
window.addEventListener('error', e => {
  if(String(e && e.message).toLowerCase().includes('metamask')){
    console.warn('Ignored external MetaMask error in sandbox:', e.message);
    e.preventDefault();
  }
}, true);

// ---- เก็บโลโก้ใน LocalStorage ----
const logoStoreKey = 'school-logos-v3';
const getLogos = () => JSON.parse(localStorage.getItem(logoStoreKey) || '{}');
const setLogos = obj => localStorage.setItem(logoStoreKey, JSON.stringify(obj));

// ---- ข้อมูลโรงเรียน (เพิ่มโลโก้จากเว็บไซต์ทางการ + 5 โรงเรียนประถมใหม่) ----
// SCHOOLS loaded from external file;

// ---- ฟังก์ชันช่วย ----
function fmtMin(m){ return m + ' นาที'; }
function fmtKm(km){ return km.toFixed(1) + ' กม.'; }
function stripParens(s){ let out='', depth=0; for(const ch of s){ if(ch==='('){ depth++; continue; } if(ch===')'){ if(depth>0) depth--; continue; } if(depth===0) out+=ch; } return out; }
function initials(name){ const cleaned = stripParens(name).trim(); const words = cleaned.split(' ').filter(Boolean); let res=''; for(let i=0;i<words.length && i<3;i++){ res += (words[i][0]||'').toUpperCase(); } return res || 'SCH'; }

let chartAll;
function updateCharts(rows){
  const labels = rows.map(s=>s.name);
  const dist = rows.map(s=>s.distance_km);
  const go = rows.map(s=>s.time_peak8_min);
  const back = rows.map(s=>s.time_peak15_min);
  document.getElementById('charts').style.display = rows.length? 'block':'none';
  const data = {
    labels,
    datasets:[
      {label:'ระยะทาง (กม.)',data:dist,backgroundColor:'rgba(91,209,255,0.7)'},
      {label:'ไป 08:00 (นาที)',data:go,backgroundColor:'rgba(133,240,137,0.7)'},
      {label:'กลับ 15:00 (นาที)',data:back,backgroundColor:'rgba(255,209,102,0.7)'}
    ]
  };
  const options = {indexAxis:'y',responsive:true,plugins:{legend:{display:true}},scales:{x:{beginAtZero:true}}};

  if(chartAll){
    chartAll.data = data;
    chartAll.update();
  } else {
    chartAll = new Chart(document.getElementById('chartAll'),{
      type:'bar',
      data,
      options
    });
  }
}

function card(s){
  const logos = getLogos();
  const stored = logos[s.name];
  const logoEl = stored ? '<img alt="โลโก้ '+s.name+'" src="'+stored+'" referrerpolicy="no-referrer">'
                        : (s.logoUrl ? '<img alt="โลโก้ '+s.name+'" src="'+s.logoUrl+'" referrerpolicy="no-referrer">'
                                     : '<div class="initial">'+initials(s.name)+'</div>');
  const mapUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(s.mapQuery);
  const id = btoa(encodeURIComponent(s.name));
  return (
    '<article class="panel card" data-name="'+s.name+'" data-system="'+s.system+'" data-type="'+s.type+'" data-distance="'+s.distance_km+'" data-normal="'+s.time_normal_min+'" data-peak8="'+s.time_peak8_min+'" data-peak15="'+s.time_peak15_min+'">\n'
    + '  <div class="title">\n'
    + '    <div class="logo" id="logo-'+id+'">'+logoEl+'</div>\n'
    + '    <div>'+s.name+'</div>\n'
    + '    <div class="logoBar">\n'
    + '      <button class="pill" data-act="map" data-href="'+mapUrl+'">แผนที่</button>\n'
    + '      <button class="pill" data-act="web" data-href="'+s.website+'">เว็บไซต์</button>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '  <div class="meta">\n'
    + '    <span class="pill">ระยะทาง: '+fmtKm(s.distance_km)+'</span>\n'
    + '    <span class="pill">ไป (ปกติ): '+fmtMin(s.time_normal_min)+'</span>\n'
    + '    <span class="pill warn">ไป 08:00: '+fmtMin(s.time_peak8_min)+'</span>\n'
    + '    <span class="pill warn">กลับ 15:00: '+fmtMin(s.time_peak15_min)+'</span>\n'
    + '  </div>\n'
    + '  <div class="badges">\n'
    + '    <span class="badge">ระบบ: '+s.system+'</span>\n'
    + '    <span class="badge">หมวด: '+s.type+'</span>\n'
    + '  </div>\n'
    + '  <div>หลักสูตร: '+s.curriculum+'</div>\n'
    + '  <div>ค่าเทอม: '+s.tuition+'</div>\n'
    + '  <div class="proscons">\n'
    + '    <div>\n'
    + '      <div class="soft">ข้อดี</div>\n'
    + '      <ul>'+s.pros.map(x=>'<li>'+x+'</li>').join('')+'</ul>\n'
    + '    </div>\n'
    + '    <div>\n'
    + '      <div class="soft">ข้อเสีย</div>\n'
    + '      <ul>'+s.cons.map(x=>'<li>'+x+'</li>').join('')+'</ul>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '</article>'
  );
}

function render(){
  const q = document.querySelector('#q').value.trim().toLowerCase();
  const sys = document.querySelector('#system').value;
  const maxKm = Number(document.querySelector('#maxKm').value);
  const maxGo = Number(document.querySelector('#maxGo').value);
  const maxBack = Number(document.querySelector('#maxBack').value);
  const sortBy = document.querySelector('#sort').value;

  let out = SCHOOLS.filter(s => {
    const hay = (s.name + ' ' + s.type + ' ' + s.system + ' ' + s.tuition + ' ' + s.curriculum).toLowerCase();
    const hitQ = !q || hay.includes(q);
    const hitSys = !sys || s.system === sys;
    const hitKm = s.distance_km <= maxKm;
    const hitGo = s.time_peak8_min <= maxGo;
    const hitBack = s.time_peak15_min <= maxBack;
    return hitQ && hitSys && hitKm && hitGo && hitBack;
  });

  out.sort((a,b)=>{
    if(sortBy==='name') return a.name.localeCompare(b.name,'th');
    if(sortBy==='distance') return a.distance_km - b.distance_km;
    if(sortBy==='normal') return a.time_normal_min - b.time_normal_min;
    if(sortBy==='peak8') return a.time_peak8_min - b.time_peak8_min;
    if(sortBy==='peak15') return a.time_peak15_min - b.time_peak15_min;
    return 0;
  });

  out = out.slice(0,1);

  document.querySelector('#results').innerHTML = out.map(card).join('');
  updateCharts(out);

  document.getElementById('summary').style.display = out.length ? 'block' : 'none';
  document.querySelector('#summaryBody').innerHTML = out.map(s=>`
        <tr>
          <td>${s.name}</td>
          <td style="text-align:right">${s.time_peak8_min}</td>
          <td style="text-align:right">${s.time_peak15_min}</td>
          <td>${s.tuition}</td>
          <td>${s.pros.join('<br>')}</td>
          <td>${s.cons.join('<br>')}</td>
        </tr>
      `).join('');

  // แผนที่
  document.querySelectorAll('[data-act="map"]').forEach(btn=>{ btn.onclick = ()=> window.open(btn.dataset.href,'_blank'); });
  document.querySelectorAll('[data-act="web"]').forEach(btn=>{ btn.onclick = ()=> window.open(btn.dataset.href,'_blank'); });
}

['q','system','sort','maxKm','maxGo','maxBack'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    if(id==='maxKm') document.getElementById('maxKmVal').textContent = '≤ ' + document.getElementById('maxKm').value + ' กม.';
    if(id==='maxGo') document.getElementById('maxGoVal').textContent = '≤ ' + document.getElementById('maxGo').value + ' นาที';
    if(id==='maxBack') document.getElementById('maxBackVal').textContent = '≤ ' + document.getElementById('maxBack').value + ' นาที';
    render();
  });
});

document.getElementById('btnReset').addEventListener('click',()=>{
  document.getElementById('q').value='';
  document.getElementById('system').value='';
  document.getElementById('sort').value='name';
  document.getElementById('maxKm').value=40; document.getElementById('maxKmVal').textContent='≤ 40 กม.';
  document.getElementById('maxGo').value=120; document.getElementById('maxGoVal').textContent='≤ 120 นาที';
  document.getElementById('maxBack').value=120; document.getElementById('maxBackVal').textContent='≤ 120 นาที';
  if(confirm('ต้องการลบโลโก้ที่บันทึกไว้หรือไม่?')) setLogos({});
  render();
});

Array.from(document.getElementById('quick').querySelectorAll('.chip')).forEach(el=>{
  el.addEventListener('click',()=>{ document.getElementById('system').value = el.dataset.sys; render(); })
});

// ส่งออก CSV
function toCSV(rows){
  const escape = v => '"'+String(v).replaceAll('"','""')+'"';
  const header = ['โรงเรียน','ระบบ','หมวด','ระยะทาง(กม.)','ไป-ปกติ(นาที)','ไป08:00(นาที)','กลับ15:00(นาที)','หลักสูตร','ค่าเทอม'];
  const body = rows.map(s=>[s.name,s.system,s.type,s.distance_km,s.time_normal_min,s.time_peak8_min,s.time_peak15_min,s.curriculum,s.tuition].map(escape).join(','));
  return [header.map(escape).join(','),...body].join('\n');
}

document.getElementById('btnExport').addEventListener('click',()=>{
  const blob = new Blob([toCSV(SCHOOLS)],{type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'schools-comparison-zone-pmsa2.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// --- ชุดทดสอบภายใน (Self-tests) ---
function runSelfTests(){
  const results = [];
  // TC1: sort by distance asc
  const sorted = [...SCHOOLS].sort((a,b)=>a.distance_km-b.distance_km);
  results.push({name:'Sort by distance', pass: sorted[0].distance_km <= sorted[1].distance_km});
  // TC2: filter by maxGo=30 ควรตัดโรงเรียนที่ใช้เวลาไปเช้าเกิน 30 นาทีทั้งหมด
  const fastMorning = SCHOOLS.filter(s=>s.time_peak8_min<=30);
  const allOk = fastMorning.every(s=>s.time_peak8_min<=30);
  results.push({name:'Filter morning <=30', pass: allOk});
  // TC3: filter by system อังกฤษ แล้วทุกตัวในผลต้องเป็นอังกฤษ
  const enOnly = SCHOOLS.filter(s=>s.system==='อังกฤษ');
  const sysOk = enOnly.every(s=>s.system==='อังกฤษ');
  results.push({name:'System filter EN', pass: sysOk});
  // สรุป
  const ok = results.every(r=>r.pass);
  console.group('SELF TESTS');
  results.forEach(r=>console.log((r.pass?'✅':'❌'), r.name));
  console.log('All passed:', ok);
  console.groupEnd();
  alert('Self-test completed. Passed: '+ (ok?'YES':'NO') +'\n\nรายละเอียดดูที่ Console');
}

document.getElementById('btnTest').addEventListener('click', runSelfTests);

render();
</script>
</body>
</html>
