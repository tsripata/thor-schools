<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ตารางเปรียบเทียบโรงเรียน (โซนพุทธมณฑลสาย 2)</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y41Z7TFF2D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y41Z7TFF2D');
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{ --bg:#0b1220; --panel:#111a2b; --muted:#9fb0c7; --text:#e8eef6; --brand:#5bd1ff; --accent:#85f089; --chip:#1a2740; --chip2:#0f1b30; --warn:#ffd166; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0a1326 40%, #091021);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
  a{color:var(--brand);text-decoration:none}
  .wrap{max-width:1200px;margin:auto;padding:24px}
  header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  header h1{font-size:clamp(20px,3vw,28px);margin:0}
  .panel{background:rgba(255,255,255,0.03);backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,0.07);border-radius:14px}
  .filters{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:16px}
  .filters > *{grid-column:span 12}
  @media(min-width:720px){.filters > .col-4{grid-column:span 4}}
  @media(min-width:720px){.filters > .col-3{grid-column:span 3}}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--text)}
  input::placeholder{color:#9bb}
  button{cursor:pointer}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid rgba(255,255,255,0.08);font-size:12px;color:#cfe3ff}
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-top:14px}
  .card{position:relative;padding:14px;display:flex;flex-direction:column;gap:10px}
  .title{font-weight:700;display:flex;align-items:center;gap:12px}
  .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:var(--chip2);border:1px solid rgba(255,255,255,0.06)}
  .proscons{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .proscons ul{margin:0 0 0 18px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);font-size:12px}
  .soft{color:var(--muted)}
  .warn{color:#2b2b2b;background:var(--warn)}
  footer{opacity:.7;margin:20px 0 80px;font-size:13px}
  .ghost{border:1px dashed rgba(255,255,255,0.12)}
  /* โลโก้ */
  .logo{width:40px;height:40px;border-radius:10px;background:#0f1b30;border:1px solid rgba(255,255,255,0.1);display:grid;place-items:center;overflow:hidden}
  .logo img{display:block;width:100%;height:100%;object-fit:contain;background:#fff}
  .logo .initial{font-weight:800;color:#17223a}
  .logoBar{margin-left:auto;display:flex;gap:8px}
  .tests{margin-left:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="flex:1 1 auto">
        <h1>เปรียบเทียบโรงเรียน (จุดอ้างอิง: โซนพุทธมณฑลสาย 2)</h1>
        <div class="soft">ภาษา: ไทย • อัปเดต: ส.ค. 2568 • ไม่มีข้อมูลส่วนบุคคลระบุที่อยู่</div>
      </div>
      <div class="row">
        <button id="btnReset" title="ล้างตัวกรอง" class="pill ghost">ล้างตัวกรอง</button>
        <button id="btnExport" class="pill">ดาวน์โหลด CSV</button>
        <button id="btnTest" class="pill tests" title="รันการทดสอบภายใน">ตรวจสอบระบบ</button>
      </div>
    </header>

    <section class="panel filters" aria-label="ตัวกรองและการค้นหา">
      <input id="q" placeholder="ค้นหา: ชื่อโรงเรียน / หมวด / หลักสูตร / หมายเหตุค่าเทอม" class="col-4" />
      <select id="system" class="col-3" title="ระบบการสอน">
        <option value="">ระบบการสอน — ทั้งหมด</option>
        <option>อังกฤษ</option>
        <option>สิงคโปร์</option>
        <option>อเมริกัน</option>
        <option>สองภาษา</option>
        <option>ทางเลือก</option>
      </select>
      <select id="sort" class="col-3" title="เรียงลำดับ">
        <option value="name">เรียงตามชื่อ</option>
        <option value="distance">ระยะทาง (กม.)</option>
        <option value="normal">เวลาไป (ปกติ)</option>
        <option value="peak8">เวลาไป 08:00</option>
        <option value="peak15">เวลากลับ 15:00</option>
      </select>
      <div class="row col-4">
        <label class="soft" style="min-width:160px">ระยะทางสูงสุด (กม.)</label>
        <input id="maxKm" type="range" min="0" max="40" value="40" style="flex:1"/>
        <div id="maxKmVal" class="pill">≤ 40 กม.</div>
      </div>
      <div class="row col-4">
        <label class="soft" style="min-width:160px">กรองเวลาไป รร. (08:00)</label>
        <input id="maxGo" type="range" min="0" max="120" value="120" style="flex:1"/>
        <div id="maxGoVal" class="pill">≤ 120 นาที</div>
      </div>
      <div class="row col-4">
        <label class="soft" style="min-width:160px">กรองเวลากลับบ้าน (15:00)</label>
        <input id="maxBack" type="range" min="0" max="120" value="120" style="flex:1"/>
        <div id="maxBackVal" class="pill">≤ 120 นาที</div>
      </div>
  <div class="chips col-12" id="quick">
    <span class="chip" data-sys="ทางเลือก">#ทางเลือก</span>
    <span class="chip" data-sys="อังกฤษ">#อังกฤษ</span>
    <span class="chip" data-sys="สิงคโปร์">#สิงคโปร์</span>
    <span class="chip" data-sys="อเมริกัน">#อเมริกัน</span>
    <span class="chip" data-sys="สองภาษา">#สองภาษา</span>
  </div>
</section>

    <section id="charts" class="panel" style="margin-top:14px;padding:16px">
      <canvas id="chartDistance" height="220"></canvas>
      <canvas id="chartGo" height="220" style="margin-top:20px"></canvas>
      <canvas id="chartBack" height="220" style="margin-top:20px"></canvas>
    </section>

    <section id="results" class="list" aria-live="polite"></section>

    <footer>
      <p>หมายเหตุ: เวลาเดินทางเป็นค่าประมาณ—“เวลา 15:00” คือเวลากลับจากโรงเรียนมาบ้าน • สามารถอัปโหลดโลโก้ทับได้และจะถูกเก็บไว้เฉพาะในเบราว์เซอร์ของคุณ</p>
    </footer>
  </div>

<script>
// ป้องกันข้อผิดพลาดจากสคริปต์ภายนอก (ไม่มีการเชื่อมต่อกระเป๋าเงินใด ๆ ในหน้านี้)
window.addEventListener('error', e => {
  if(String(e && e.message).toLowerCase().includes('metamask')){
    console.warn('Ignored external MetaMask error in sandbox:', e.message);
    e.preventDefault();
  }
}, true);

// ---- เก็บโลโก้ใน LocalStorage ----
const logoStoreKey = 'school-logos-v3';
const getLogos = () => JSON.parse(localStorage.getItem(logoStoreKey) || '{}');
const setLogos = obj => localStorage.setItem(logoStoreKey, JSON.stringify(obj));

// ---- ข้อมูลโรงเรียน (เพิ่มโลโก้จากเว็บไซต์ทางการ + 5 โรงเรียนประถมใหม่) ----
const SCHOOLS = [
  { name: 'โรงเรียนจิตตเมตต์ (Jittamett) — ทางเลือก', type:'ทางเลือก', system:'ทางเลือก', distance_km:6.9, time_normal_min:12, time_peak8_min:20, time_peak15_min:16, tuition:'≈ 158,540 บาท/ปี (2 เทอม)', curriculum:'การเรียนรวมต่างวัย เน้น EF, Orff Schulwerk, Free Day', mapQuery:'Jittamett Kindergarten', logoUrl:'https://www.jittamett.ac.th/favicon.ico', website:'https://www.jittamett.ac.th/', pros:['บรรยากาศการเรียนยืดหยุ่น เน้นทักษะชีวิตและ EF','เด็กต่างวัยเรียนร่วม—พัฒนาสังคม','งานดนตรี/การเคลื่อนไหวเด่น'], cons:['ไม่ใช่หลักสูตรนานาชาติ—ต้องเตรียมสะพานวิชาเมื่อย้าย','การประเมินเชิงวิชาการอาจไม่เข้มเท่าโรงเรียนสากล'] },
  { name: 'Kidz Village International Kindergarten', type:'นานาชาติปฐมวัย', system:'อังกฤษ', distance_km:4.9, time_normal_min:9, time_peak8_min:16, time_peak15_min:14, tuition:'FS1 ≈ 257,100฿/ปี • FS2 ≈ 380,280฿/ปี • Y1–Y2 ≈ 394,080–417,150฿/ปี', curriculum:'EYFS (อังกฤษ), Play-based', mapQuery:'Kidz Village International Kindergarten', logoUrl:'https://kidz-village.ac.th/favicon.ico', website:'https://kidz-village.ac.th/', pros:['ใกล้ เดินทางสั้น','กิจกรรมสร้างสรรค์สำหรับปฐมวัย'], cons:['เปิดถึง Y2—ต้องย้ายตอนเข้าประถม','ค่าใช้จ่ายเสริมอาจเพิ่ม'] },
  { name: 'International Pioneers School (IPS)', type:'นานาชาติ', system:'อังกฤษ', distance_km:19.7, time_normal_min:24, time_peak8_min:45, time_peak15_min:38, tuition:'ประถม ≤ 200,000฿/ปี (ประมาณ)', curriculum:'Cambridge/Edexcel (UK), WASC', mapQuery:'International Pioneers School Bangkok', logoUrl:'https://ips.ac.th/favicon.ico', website:'https://ips.ac.th/', pros:['ค่าเทอมย่อมเยา','เปิดถึง Y13 ต่อเนื่อง'], cons:['ระยะทางไกลกว่า','สิ่งอำนวยความสะดวกบางส่วนอาจไม่หรู'] },
  { name: 'SISB Thonburi (Singapore International School of Bangkok)', type:'นานาชาติ', system:'สิงคโปร์', distance_km:8.6, time_normal_min:16, time_peak8_min:26, time_peak15_min:22, tuition:'~400,000–600,000฿/ปี', curriculum:'อนุบาล EYFS, ประถมสิงคโปร์, มัธยม IGCSE/A-Level', mapQuery:'SISB Thonburi', logoUrl:'https://sisb.ac.th/favicon.ico', website:'https://sisb.ac.th/', pros:['เด่นคณิต/วิทย์','สอน 3 ภาษา'], cons:['แข่งขันสูง','ค่าใช้จ่ายรวมกิจกรรมอาจเพิ่ม'] },
  { name: 'โรงเรียนเพลินพัฒนา — ทางเลือก', type:'ทางเลือก', system:'ทางเลือก', distance_km:3.9, time_normal_min:8, time_peak8_min:14, time_peak15_min:12, tuition:'≈ 185,000–195,000฿/ปี', curriculum:'Active Learning, โครงงาน, พัฒนา EF', mapQuery:'Plearnpattana School', logoUrl:'https://plearnpattana.ac.th/favicon.ico', website:'https://plearnpattana.ac.th/', pros:['ใกล้มาก','วัฒนธรรมการเรียนรู้เป็นมิตร'], cons:['การโอนไปหลักสูตรสากลต้องเตรียม','ที่นั่งเต็มเร็ว'] },
  { name: 'โรงเรียนอำนวยศิลป์ (Amnuay Silpa) — สองภาษา', type:'สองภาษา', system:'สองภาษา', distance_km:20.5, time_normal_min:31, time_peak8_min:55, time_peak15_min:48, tuition:'≈ 400,000฿/ปี (ประมาณ)', curriculum:'ผสมหลักสูตรไทยกับแนวสมัยใหม่ เน้นภาษาอังกฤษ', mapQuery:'Amnuay Silpa School', logoUrl:'https://www.amnuaysilpa.ac.th/favicon.ico', website:'https://www.amnuaysilpa.ac.th/', pros:['เครือข่ายศิษย์เก่าใหญ่','เหมาะครอบครัวที่อยากคงแกนไทย'], cons:['ไกลกว่าหลายตัวเลือก','แข่งขันสูง/ที่นั่งจำกัด'] },
  { name: 'Shrewsbury International School Bangkok — Riverside', type:'นานาชาติ', system:'อังกฤษ', distance_km:21.8, time_normal_min:36, time_peak8_min:65, time_peak15_min:55, tuition:'FS1 ≈ 591,000฿/ปี • Y2 ≈ 720,300฿/ปี • Y12–13 ≈ 1,066,800฿/ปี', curriculum:'English National Curriculum → IGCSE/A-Level', mapQuery:'Shrewsbury International School Bangkok Riverside', logoUrl:'https://www.shrewsbury.ac.th/favicon.ico', website:'https://www.shrewsbury.ac.th/', pros:['ชื่อเสียงและผลสัมฤทธิ์สูง','ทำเลริมเจ้าพระยา กิจกรรมเด่น'], cons:['ไกลและใช้เวลาช่วงเร่งด่วนสูง','ค่าใช้จ่ายสูง'] },
  { name: 'BASIS International School Bangkok', type:'นานาชาติ', system:'อเมริกัน', distance_km:20.6, time_normal_min:25, time_peak8_min:42, time_peak15_min:36, tuition:'ปฐมวัย ~520,000฿/ปี; Pre-K–Kinder ~605,000฿/ปี', curriculum:'American (BASIS Curriculum)', mapQuery:'BASIS International School Bangkok', logoUrl:'https://basis.ac.th/favicon.ico', website:'https://basis.ac.th/', pros:['วิชาการเข้ม โดยเฉพาะวิทย์-คณิต','ต่อเนื่องถึงเกรดสูง'], cons:['แรงกดดันด้านการบ้าน/การสอบมากกว่า','ค่าใช้จ่ายสูง'] },
  { name: 'Kensington International School / Kindergarten', type:'นานาชาติปฐมวัย+ประถมต้น', system:'อังกฤษ', distance_km:10.5, time_normal_min:15, time_peak8_min:26, time_peak15_min:21, tuition:'ค่าแรกเข้าประมาณ 100,000฿; Reception ~465,000–562,500฿/ปี (โปรดยืนยัน)', curriculum:'EYFS (อังกฤษ), Play-based → Primary อังกฤษ', mapQuery:'Kensington International Kindergarten', logoUrl:'https://kensington.ac.th/favicon.ico', website:'https://kensington.ac.th/', pros:['ทำเลใกล้ สิ่งแวดล้อมเป็นมิตร','Play-based ชัดเจน'], cons:['ข้อมูลค่าเทอมอาจเปลี่ยนแปลง','ที่นั่งนิยมสูง'] },
  { name: 'DBS — Denla British School', type:'นานาชาติ', system:'อังกฤษ', distance_km:25.2, time_normal_min:29, time_peak8_min:52, time_peak15_min:45, tuition:'FS1 514,000฿/ปี; KG1 650,620฿; Y1–Y5 ≈ 774,430฿; Y6–Y8 852,540฿; Y9–Y11 907,980฿; Y12–13 968,050฿', curriculum:'British independent school → IGCSE/A-Level', mapQuery:'DBS Denla British School', logoUrl:'https://www.dbsbangkok.ac.th/favicon.ico', website:'https://www.dbsbangkok.ac.th/', pros:['สิ่งอำนวยความสะดวกครบ','เส้นทางสู่ IGCSE/A-Level'], cons:['ไกลกว่าโซนใกล้บ้าน','ค่าใช้จ่ายระดับพรีเมียม'] },

  // เพิ่มอีก 5 โรงเรียน (ระดับประถม)
  { name: 'St. Andrews International School, Sukhumvit 107 (S107)', type:'นานาชาติ', system:'อังกฤษ', distance_km:35, time_normal_min:45, time_peak8_min:75, time_peak15_min:65, tuition:'ประถม ~450,000–650,000฿/ปี', curriculum:'English National Curriculum → IGCSE/A-Level', mapQuery:'St Andrews International School Sukhumvit 107', logoUrl:'https://www.standrewssukhumvit.com/favicon.ico', website:'https://www.standrewssukhumvit.com/', pros:['สภาพแวดล้อมดี กิจกรรมครบ','ผลวิชาการสม่ำเสมอ'], cons:['ไกลจากฝั่งตะวันตก','รถติดมากช่วงเช้า–บ่าย'] },
  { name: 'Ekamai International School (EIS)', type:'นานาชาติ', system:'อเมริกัน', distance_km:24, time_normal_min:40, time_peak8_min:70, time_peak15_min:60, tuition:'ประถม ~300,000–450,000฿/ปี', curriculum:'American (WASC)', mapQuery:'Ekamai International School', logoUrl:'https://www.eis.ac.th/favicon.ico', website:'https://www.eis.ac.th/', pros:['ค่าเทอมระดับกลาง','ชุมชนโรงเรียนอบอุ่น'], cons:['ทำเลสุขุมวิท รถติดจัด','สิ่งอำนวยความสะดวกบางส่วนไม่ใหญ่'] },
  { name: 'KIS International School Bangkok (IB)', type:'นานาชาติ', system:'ทางเลือก', distance_km:24, time_normal_min:40, time_peak8_min:65, time_peak15_min:60, tuition:'ประถม (IB PYP) ~500,000–650,000฿/ปี', curriculum:'IB Continuum: PYP → MYP → DP', mapQuery:'KIS International School Bangkok', logoUrl:'https://www.kis.ac.th/favicon.ico', website:'https://www.kis.ac.th/', pros:['IB เต็มรูปแบบตั้งแต่ประถม','โฟกัสทักษะคิด–ลงมือทำ'], cons:['ค่าใช้จ่ายสูงกว่าค่าเฉลี่ย','โปรเจกต์งานต่อเนื่อง'] },
  { name: 'NIST International School (IB)', type:'นานาชาติ', system:'ทางเลือก', distance_km:22, time_normal_min:35, time_peak8_min:60, time_peak15_min:55, tuition:'ประถม (IB PYP) ~650,000–800,000฿/ปี', curriculum:'IB PYP → MYP → DP', mapQuery:'NIST International School', logoUrl:'https://www.nist.ac.th/favicon.ico', website:'https://www.nist.ac.th/', pros:['ชื่อเสียงระดับท็อป IB','กิจกรรมหลากหลาย'], cons:['ค่าเทอมสูง','ช่วงเร่งด่วนเดินทางนาน'] },
  { name: 'Harrow International School Bangkok', type:'นานาชาติ', system:'อังกฤษ', distance_km:35, time_normal_min:45, time_peak8_min:75, time_peak15_min:70, tuition:'ประถม ~700,000–900,000฿/ปี', curriculum:'English National Curriculum → IGCSE/A-Level', mapQuery:'Harrow International School Bangkok', logoUrl:'https://www.harrowschool.ac.th/favicon.ico', website:'https://www.harrowschool.ac.th/', pros:['มาตรฐานสูง สิ่งอำนวยความสะดวกครบ','สายกิจกรรม–กีฬาเด่น'], cons:['ไกลจากโซนพุทธมณฑล','ค่าใช้จ่ายสูง'] },
  { name: 'โรงเรียนเลิร์นสาธิตพัฒนา (LEARN Satitpattana)', type:'ทางเลือก', system:'ทางเลือก', distance_km:39, time_normal_min:50, time_peak8_min:80, time_peak15_min:70, tuition:'≈ 150,000–200,000฿/ปี', curriculum:'โครงงานบูรณาการ เน้นค้นพบความถนัด', mapQuery:'Satitpattana School', logoUrl:'https://satitpattana.ac.th/favicon.ico', website:'https://satitpattana.ac.th/', pros:['ชุมชนอบอุ่น เน้นพัฒนาศักยภาพรายบุคคล','กิจกรรมสร้างสรรค์หลากหลาย'], cons:['อยู่ไกลจากโซนพุทธมณฑลสาย 2','ข้อมูลค่าเทอมต้องสอบถามเพิ่มเติม'] },

  // เพิ่มอีก 5 โรงเรียน (โฟกัสระดับประถมสำหรับอายุ ~5 ปี)
  { name: 'Bangkok International Preparatory & Secondary School (Bangkok Prep) — Primary', type:'นานาชาติ', system:'อังกฤษ', distance_km:27, time_normal_min:35, time_peak8_min:60, time_peak15_min:55, tuition:'ประถม ~500,000–650,000฿/ปี', curriculum:'English National Curriculum → IGCSE/A-Level', mapQuery:'Bangkok Prep Primary Campus', logoUrl:'https://www.bkkprep.ac.th/favicon.ico', website:'https://www.bkkprep.ac.th/', pros:['โปรแกรมวิชาการและกิจกรรมหลากหลาย','มีสองแคมปัสแยกประถม/มัธยม'], cons:['ค่าเทอมค่อนข้างสูง','ทำเลสุขุมวิท รถติดช่วงเร่งด่วน'] },
  { name: 'Concordian International School', type:'นานาชาติ', system:'ทางเลือก', distance_km:39, time_normal_min:50, time_peak8_min:85, time_peak15_min:80, tuition:'ประถม (IB PYP) ~650,000–750,000฿/ปี', curriculum:'IB PYP → MYP → DP (ไทย-อังกฤษ-จีน)', mapQuery:'Concordian International School', logoUrl:'https://www.concordian.ac.th/favicon.ico', website:'https://www.concordian.ac.th/', pros:['สอนสามภาษา ไทย-อังกฤษ-จีน','IB เต็มรูปแบบตั้งแต่อนุบาล'], cons:['ระยะทางไกลจากฝั่งตะวันตก','ค่าเทอมสูง'] },
  { name: 'Wells International School (On Nut)', type:'นานาชาติ', system:'อเมริกัน', distance_km:28, time_normal_min:40, time_peak8_min:70, time_peak15_min:60, tuition:'ประถม ~260,000–350,000฿/ปี', curriculum:'American (WASC) → AP', mapQuery:'Wells International School On Nut', logoUrl:'https://wells.ac.th/favicon.ico', website:'https://wells.ac.th/', pros:['ค่าเทอมไม่สูงมากในกลุ่มนานาชาติ','ชุมชนขนาดกระทัดรัด'], cons:['พื้นที่โรงเรียนจำกัด','ช่วงเร่งด่วนรถติด'] },
  { name: 'Thai-Singapore International School (TSIS)', type:'นานาชาติ', system:'สิงคโปร์', distance_km:30, time_normal_min:40, time_peak8_min:70, time_peak15_min:60, tuition:'ประถม ~300,000–450,000฿/ปี', curriculum:'Singapore Curriculum → Cambridge IGCSE', mapQuery:'Thai-Singapore International School', logoUrl:'https://tsis.ac.th/favicon.ico', website:'https://tsis.ac.th/', pros:['เน้นคณิต-วิทย์แบบสิงคโปร์','ค่าเทอมปานกลาง'], cons:['อยู่ฝั่งตะวันออกของเมือง','การเดินทางค่อนข้างไกล'] },
  { name: 'Ruamrudee International School (RIS)', type:'นานาชาติ', system:'อเมริกัน', distance_km:38, time_normal_min:55, time_peak8_min:90, time_peak15_min:85, tuition:'ประถม ~500,000–600,000฿/ปี', curriculum:'American (US) → IB DP/AP', mapQuery:'Ruamrudee International School', logoUrl:'https://www.rism.ac.th/favicon.ico', website:'https://www.rism.ac.th/', pros:['ชื่อเสียงเก่าแก่ วัฒนธรรมคาทอลิก','มีเส้นทาง IB และ AP'], cons:['ไกลจากโซนพุทธมณฑลมาก','ค่าใช้จ่ายสูง'] }
];

// ---- ฟังก์ชันช่วย ----
function fmtMin(m){ return m + ' นาที'; }
function fmtKm(km){ return km.toFixed(1) + ' กม.'; }
function stripParens(s){ let out='', depth=0; for(const ch of s){ if(ch==='('){ depth++; continue; } if(ch===')'){ if(depth>0) depth--; continue; } if(depth===0) out+=ch; } return out; }
function initials(name){ const cleaned = stripParens(name).trim(); const words = cleaned.split(' ').filter(Boolean); let res=''; for(let i=0;i<words.length && i<3;i++){ res += (words[i][0]||'').toUpperCase(); } return res || 'SCH'; }

let chartDist, chartGo, chartBack;
function updateCharts(rows){
  const labels = rows.map(s=>s.name);
  const dist = rows.map(s=>s.distance_km);
  const go = rows.map(s=>s.time_peak8_min);
  const back = rows.map(s=>s.time_peak15_min);
  document.getElementById('charts').style.display = rows.length? 'block':'none';
  const common = {indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}};


  if(chartDist){ chartDist.data.labels=labels; chartDist.data.datasets[0].data=dist; chartDist.update(); }
  else{
    chartDist = new Chart(document.getElementById('chartDistance'),{
      type:'bar',
      data:{labels,datasets:[{label:'ระยะทาง (กม.)',data:dist,backgroundColor:'rgba(91,209,255,0.7)'}]},
      options:common
    });
  }
  if(chartGo){ chartGo.data.labels=labels; chartGo.data.datasets[0].data=go; chartGo.update(); }
  else{
    chartGo = new Chart(document.getElementById('chartGo'),{
      type:'bar',
      data:{labels,datasets:[{label:'ไป 08:00 (นาที)',data:go,backgroundColor:'rgba(133,240,137,0.7)'}]},
      options:common
    });
  }
  if(chartBack){ chartBack.data.labels=labels; chartBack.data.datasets[0].data=back; chartBack.update(); }
  else{
    chartBack = new Chart(document.getElementById('chartBack'),{
      type:'bar',
      data:{labels,datasets:[{label:'กลับ 15:00 (นาที)',data:back,backgroundColor:'rgba(255,209,102,0.7)'}]},
      options:common
    });
  }
}

function card(s){
  const logos = getLogos();
  const stored = logos[s.name];
  const logoEl = stored ? '<img alt="โลโก้ '+s.name+'" src="'+stored+'" referrerpolicy="no-referrer">'
                        : (s.logoUrl ? '<img alt="โลโก้ '+s.name+'" src="'+s.logoUrl+'" referrerpolicy="no-referrer">'
                                     : '<div class="initial">'+initials(s.name)+'</div>');
  const mapUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(s.mapQuery);
  const id = btoa(encodeURIComponent(s.name));
  return (
    '<article class="panel card" data-name="'+s.name+'" data-system="'+s.system+'" data-type="'+s.type+'" data-distance="'+s.distance_km+'" data-normal="'+s.time_normal_min+'" data-peak8="'+s.time_peak8_min+'" data-peak15="'+s.time_peak15_min+'">\n'
    + '  <div class="title">\n'
    + '    <div class="logo" id="logo-'+id+'">'+logoEl+'</div>\n'
    + '    <div>'+s.name+'</div>\n'
    + '    <div class="logoBar">\n'
    + '      <button class="pill" data-act="map" data-href="'+mapUrl+'">แผนที่</button>\n'
    + '      <button class="pill" data-act="web" data-href="'+s.website+'">เว็บไซต์</button>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '  <div class="meta">\n'
    + '    <span class="pill">ระยะทาง: '+fmtKm(s.distance_km)+'</span>\n'
    + '    <span class="pill">ไป (ปกติ): '+fmtMin(s.time_normal_min)+'</span>\n'
    + '    <span class="pill warn">ไป 08:00: '+fmtMin(s.time_peak8_min)+'</span>\n'
    + '    <span class="pill warn">กลับ 15:00: '+fmtMin(s.time_peak15_min)+'</span>\n'
    + '  </div>\n'
    + '  <div class="badges">\n'
    + '    <span class="badge">ระบบ: '+s.system+'</span>\n'
    + '    <span class="badge">หมวด: '+s.type+'</span>\n'
    + '  </div>\n'
    + '  <div>หลักสูตร: '+s.curriculum+'</div>\n'
    + '  <div>ค่าเทอม: '+s.tuition+'</div>\n'
    + '  <div class="proscons">\n'
    + '    <div>\n'
    + '      <div class="soft">ข้อดี</div>\n'
    + '      <ul>'+s.pros.map(x=>'<li>'+x+'</li>').join('')+'</ul>\n'
    + '    </div>\n'
    + '    <div>\n'
    + '      <div class="soft">ข้อเสีย</div>\n'
    + '      <ul>'+s.cons.map(x=>'<li>'+x+'</li>').join('')+'</ul>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '</article>'
  );
}

function render(){
  const q = document.querySelector('#q').value.trim().toLowerCase();
  const sys = document.querySelector('#system').value;
  const maxKm = Number(document.querySelector('#maxKm').value);
  const maxGo = Number(document.querySelector('#maxGo').value);
  const maxBack = Number(document.querySelector('#maxBack').value);
  const sortBy = document.querySelector('#sort').value;

  let out = SCHOOLS.filter(s => {
    const hay = (s.name + ' ' + s.type + ' ' + s.system + ' ' + s.tuition + ' ' + s.curriculum).toLowerCase();
    const hitQ = !q || hay.includes(q);
    const hitSys = !sys || s.system === sys;
    const hitKm = s.distance_km <= maxKm;
    const hitGo = s.time_peak8_min <= maxGo;
    const hitBack = s.time_peak15_min <= maxBack;
    return hitQ && hitSys && hitKm && hitGo && hitBack;
  });

  out.sort((a,b)=>{
    if(sortBy==='name') return a.name.localeCompare(b.name,'th');
    if(sortBy==='distance') return a.distance_km - b.distance_km;
    if(sortBy==='normal') return a.time_normal_min - b.time_normal_min;
    if(sortBy==='peak8') return a.time_peak8_min - b.time_peak8_min;
    if(sortBy==='peak15') return a.time_peak15_min - b.time_peak15_min;
    return 0;
  });

  document.querySelector('#results').innerHTML = out.map(card).join('');
  updateCharts(out);

  // แผนที่
  document.querySelectorAll('[data-act="map"]').forEach(btn=>{ btn.onclick = ()=> window.open(btn.dataset.href,'_blank'); });
  document.querySelectorAll('[data-act="web"]').forEach(btn=>{ btn.onclick = ()=> window.open(btn.dataset.href,'_blank'); });
}

['q','system','sort','maxKm','maxGo','maxBack'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    if(id==='maxKm') document.getElementById('maxKmVal').textContent = '≤ ' + document.getElementById('maxKm').value + ' กม.';
    if(id==='maxGo') document.getElementById('maxGoVal').textContent = '≤ ' + document.getElementById('maxGo').value + ' นาที';
    if(id==='maxBack') document.getElementById('maxBackVal').textContent = '≤ ' + document.getElementById('maxBack').value + ' นาที';
    render();
  });
});

document.getElementById('btnReset').addEventListener('click',()=>{
  document.getElementById('q').value='';
  document.getElementById('system').value='';
  document.getElementById('sort').value='name';
  document.getElementById('maxKm').value=40; document.getElementById('maxKmVal').textContent='≤ 40 กม.';
  document.getElementById('maxGo').value=120; document.getElementById('maxGoVal').textContent='≤ 120 นาที';
  document.getElementById('maxBack').value=120; document.getElementById('maxBackVal').textContent='≤ 120 นาที';
  if(confirm('ต้องการลบโลโก้ที่บันทึกไว้หรือไม่?')) setLogos({});
  render();
});

Array.from(document.getElementById('quick').querySelectorAll('.chip')).forEach(el=>{
  el.addEventListener('click',()=>{ document.getElementById('system').value = el.dataset.sys; render(); })
});

// ส่งออก CSV
function toCSV(rows){
  const escape = v => '"'+String(v).replaceAll('"','""')+'"';
  const header = ['โรงเรียน','ระบบ','หมวด','ระยะทาง(กม.)','ไป-ปกติ(นาที)','ไป08:00(นาที)','กลับ15:00(นาที)','หลักสูตร','ค่าเทอม'];
  const body = rows.map(s=>[s.name,s.system,s.type,s.distance_km,s.time_normal_min,s.time_peak8_min,s.time_peak15_min,s.curriculum,s.tuition].map(escape).join(','));
  return [header.map(escape).join(','),...body].join('\n');
}

document.getElementById('btnExport').addEventListener('click',()=>{
  const blob = new Blob([toCSV(SCHOOLS)],{type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'schools-comparison-zone-pmsa2.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// --- ชุดทดสอบภายใน (Self-tests) ---
function runSelfTests(){
  const results = [];
  // TC1: sort by distance asc
  const sorted = [...SCHOOLS].sort((a,b)=>a.distance_km-b.distance_km);
  results.push({name:'Sort by distance', pass: sorted[0].distance_km <= sorted[1].distance_km});
  // TC2: filter by maxGo=30 ควรตัดโรงเรียนที่ใช้เวลาไปเช้าเกิน 30 นาทีทั้งหมด
  const fastMorning = SCHOOLS.filter(s=>s.time_peak8_min<=30);
  const allOk = fastMorning.every(s=>s.time_peak8_min<=30);
  results.push({name:'Filter morning <=30', pass: allOk});
  // TC3: filter by system อังกฤษ แล้วทุกตัวในผลต้องเป็นอังกฤษ
  const enOnly = SCHOOLS.filter(s=>s.system==='อังกฤษ');
  const sysOk = enOnly.every(s=>s.system==='อังกฤษ');
  results.push({name:'System filter EN', pass: sysOk});
  // สรุป
  const ok = results.every(r=>r.pass);
  console.group('SELF TESTS');
  results.forEach(r=>console.log((r.pass?'✅':'❌'), r.name));
  console.log('All passed:', ok);
  console.groupEnd();
  alert('Self-test completed. Passed: '+ (ok?'YES':'NO') +'\n\nรายละเอียดดูที่ Console');
}

document.getElementById('btnTest').addEventListener('click', runSelfTests);

render();
</script>
</body>
</html>
